
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Guide francophone des patterns d'architecture logicielle en Python">
      
      
      
      
        <link rel="prev" href="../chapitre_05_tdd/">
      
      
        <link rel="next" href="../chapitre_07_aggregats/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>Chapitre 6 - Le pattern Unit of Work - Patterns d'Architecture en Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapitre-6-le-pattern-unit-of-work" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href="../.." title="Patterns d&#39;Architecture en Python" class="md-header__button md-logo" aria-label="Patterns d'Architecture en Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Patterns d'Architecture en Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapitre 6 - Le pattern Unit of Work
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Recherche">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/chris-lmd/cosmic-python-fr" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    chris-lmd/cosmic-python-fr
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Patterns d&#39;Architecture en Python" class="md-nav__button md-logo" aria-label="Patterns d'Architecture en Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Patterns d'Architecture en Python
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/chris-lmd/cosmic-python-fr" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    chris-lmd/cosmic-python-fr
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapitre_00_mise_en_route/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 0 - Mise en route
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Partie 1 - Construire une architecture pour le Domain Modeling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Partie 1 - Construire une architecture pour le Domain Modeling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_01_modele_domaine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 1 - Le modèle de domaine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_02_repository/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 2 - Le pattern Repository
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_03_abstractions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 3 - Couplage et abstractions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_04_service_layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 4 - La Service Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_05_tdd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 5 - TDD à haute et basse vitesse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 6 - Le pattern Unit of Work
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 6 - Le pattern Unit of Work
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#le-probleme-qui-controle-la-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le problème : qui contrôle la transaction ?
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Le problème : qui contrôle la transaction ?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-1-le-repository-gere-la-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option 1 : le repository gère la session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-2-le-handler-gere-la-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option 2 : le handler gère la session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-solution-un-nouvel-objet-qui-encapsule-la-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        La solution : un nouvel objet qui encapsule la transaction
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-pattern-unit-of-work" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le pattern Unit of Work
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linterface-abstraite-abstractunitofwork" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'interface abstraite : AbstractUnitOfWork
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="L&#39;interface abstraite : AbstractUnitOfWork">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#anatomie-du-context-manager-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      
        Anatomie du context manager protocol
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limplementation-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'implémentation SQLAlchemy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="L&#39;implémentation SQLAlchemy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#le-cycle-de-vie-de-la-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le cycle de vie de la session
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-collecte-des-events-collect_new_events" class="md-nav__link">
    <span class="md-ellipsis">
      
        La collecte des events : collect_new_events
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La collecte des events : collect_new_events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comment-ca-fonctionne" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comment ça fonctionne
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-fake-unit-of-work-pour-les-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le Fake Unit of Work pour les tests
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Le Fake Unit of Work pour les tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lattribut-committed-verifier-latomicite" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'attribut committed : vérifier l'atomicité
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#le-fakerepository-et-lattribut-seen" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le FakeRepository et l'attribut seen
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-flux-complet-du-handler-au-domaine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le flux complet : du handler au domaine
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resume" class="md-nav__link">
    <span class="md-ellipsis">
      
        Résumé
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Résumé">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ce-que-le-unit-of-work-apporte" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ce que le Unit of Work apporte
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#les-fichiers-cles" class="md-nav__link">
    <span class="md-ellipsis">
      
        Les fichiers clés
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#les-principes-a-retenir" class="md-nav__link">
    <span class="md-ellipsis">
      
        Les principes à retenir
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Exercices
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_07_aggregats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 7 - Agrégats et frontières de cohérence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Partie 2 - Architecture événementielle
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Partie 2 - Architecture événementielle
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_08_events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 8 - Events et le Message Bus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_09_message_bus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 9 - Aller plus loin avec le Message Bus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_10_commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 10 - Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_11_events_externes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 11 - Events externes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_12_cqrs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 12 - CQRS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_13_injection_dependances/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 13 - Injection de dépendances
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../epilogue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Épilogue
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#le-probleme-qui-controle-la-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le problème : qui contrôle la transaction ?
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Le problème : qui contrôle la transaction ?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#option-1-le-repository-gere-la-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option 1 : le repository gère la session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#option-2-le-handler-gere-la-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        Option 2 : le handler gère la session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-solution-un-nouvel-objet-qui-encapsule-la-transaction" class="md-nav__link">
    <span class="md-ellipsis">
      
        La solution : un nouvel objet qui encapsule la transaction
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-pattern-unit-of-work" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le pattern Unit of Work
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linterface-abstraite-abstractunitofwork" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'interface abstraite : AbstractUnitOfWork
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="L&#39;interface abstraite : AbstractUnitOfWork">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#anatomie-du-context-manager-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      
        Anatomie du context manager protocol
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limplementation-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'implémentation SQLAlchemy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="L&#39;implémentation SQLAlchemy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#le-cycle-de-vie-de-la-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le cycle de vie de la session
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-collecte-des-events-collect_new_events" class="md-nav__link">
    <span class="md-ellipsis">
      
        La collecte des events : collect_new_events
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La collecte des events : collect_new_events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comment-ca-fonctionne" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comment ça fonctionne
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-fake-unit-of-work-pour-les-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le Fake Unit of Work pour les tests
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Le Fake Unit of Work pour les tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lattribut-committed-verifier-latomicite" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'attribut committed : vérifier l'atomicité
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#le-fakerepository-et-lattribut-seen" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le FakeRepository et l'attribut seen
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-flux-complet-du-handler-au-domaine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le flux complet : du handler au domaine
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resume" class="md-nav__link">
    <span class="md-ellipsis">
      
        Résumé
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Résumé">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ce-que-le-unit-of-work-apporte" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ce que le Unit of Work apporte
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#les-fichiers-cles" class="md-nav__link">
    <span class="md-ellipsis">
      
        Les fichiers clés
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#les-principes-a-retenir" class="md-nav__link">
    <span class="md-ellipsis">
      
        Les principes à retenir
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Exercices
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="chapitre-6-le-pattern-unit-of-work">Chapitre 6 -- Le pattern Unit of Work<a class="headerlink" href="#chapitre-6-le-pattern-unit-of-work" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>Comment garantir que les opérations en base de données sont atomiques, sans coupler nos handlers à SQLAlchemy ?</strong></p>
</blockquote>
<p>Jusqu'ici, notre architecture repose sur un repository qui abstrait l'accès à la base de données, et une service layer qui orchestre les cas d'usage. Mais une question reste ouverte : <strong>qui gère la transaction ?</strong></p>
<p>Dans ce chapitre, nous introduisons le pattern <strong>Unit of Work</strong> -- un context manager qui encapsule la session, le repository et la transaction dans un seul objet cohérent.</p>
<hr />
<h2 id="le-probleme-qui-controle-la-transaction">Le problème : qui contrôle la transaction ?<a class="headerlink" href="#le-probleme-qui-controle-la-transaction" title="Permanent link">&para;</a></h2>
<p>Notre handler <code>allouer</code> doit faire plusieurs choses dans une seule transaction :</p>
<ol>
<li>Lire un <code>Produit</code> depuis la base</li>
<li>Appeler la logique d'allocation sur le domaine</li>
<li>Persister le résultat en base</li>
<li>Commiter la transaction</li>
</ol>
<p>La question est : <strong>où vit la gestion de la session et du commit ?</strong></p>
<h3 id="option-1-le-repository-gere-la-session">Option 1 : le repository gère la session<a class="headerlink" href="#option-1-le-repository-gere-la-session" title="Permanent link">&para;</a></h3>
<p>Si le repository crée et commite lui-même sa session, chaque opération (<code>add</code>, <code>get</code>) est indépendante. On perd <strong>l'atomicité</strong> : si l'allocation réussit mais que le commit échoue, on se retrouve dans un état incohérent.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Problème : chaque appel est une transaction séparée</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">produit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CHAISE-COMFY&quot;</span><span class="p">)</span>          <span class="c1"># transaction 1</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="n">réf_lot</span> <span class="o">=</span> <span class="n">produit</span><span class="o">.</span><span class="n">allouer</span><span class="p">(</span><span class="n">ligne</span><span class="p">)</span>            <span class="c1"># en mémoire</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">produit</span><span class="p">)</span>                          <span class="c1"># transaction 2 -- et si ça échoue ?</span>
</code></pre></div>
<h3 id="option-2-le-handler-gere-la-session">Option 2 : le handler gère la session<a class="headerlink" href="#option-2-le-handler-gere-la-session" title="Permanent link">&para;</a></h3>
<p>Si le handler crée la session SQLAlchemy et la passe au repository, on retrouve l'atomicité. Mais le handler devient <strong>couplé à SQLAlchemy</strong> -- exactement ce qu'on voulait éviter avec le repository.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Problème : le handler connaît SQLAlchemy</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">allouer</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">session_factory</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">session_factory</span><span class="p">()</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="n">repo</span> <span class="o">=</span> <span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="n">produit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="n">réf_lot</span> <span class="o">=</span> <span class="n">produit</span><span class="o">.</span><span class="n">allouer</span><span class="p">(</span><span class="n">ligne</span><span class="p">)</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># le handler manipule directement la session</span>
</code></pre></div>
<h3 id="la-solution-un-nouvel-objet-qui-encapsule-la-transaction">La solution : un nouvel objet qui encapsule la transaction<a class="headerlink" href="#la-solution-un-nouvel-objet-qui-encapsule-la-transaction" title="Permanent link">&para;</a></h3>
<p>Le <strong>Unit of Work</strong> résout ce dilemme. C'est un objet qui :</p>
<ul>
<li><strong>Crée la session</strong> à l'entrée du context manager</li>
<li><strong>Fournit le repository</strong> configuré avec cette session</li>
<li><strong>Expose <code>commit()</code> et <code>rollback()</code></strong> sans révéler l'implémentation</li>
<li><strong>Ferme la session</strong> à la sortie, avec rollback automatique si <code>commit()</code> n'a pas été appelé</li>
</ul>
<p>Le handler n'a plus besoin de connaître SQLAlchemy. Il travaille avec une <strong>abstraction</strong>.</p>
<hr />
<h2 id="le-pattern-unit-of-work">Le pattern Unit of Work<a class="headerlink" href="#le-pattern-unit-of-work" title="Permanent link">&para;</a></h2>
<p>Le Unit of Work représente une <strong>unité de travail atomique</strong>. C'est un concept formalisé par Martin Fowler dans <em>Patterns of Enterprise Application Architecture</em> : un objet qui suit les modifications faites pendant une transaction et coordonne leur écriture en base.</p>
<p>Dans notre implémentation, le Unit of Work est un <strong>context manager</strong> Python. Voici comment un handler l'utilise :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">allouer</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="n">Allouer</span><span class="p">,</span> <span class="n">uow</span><span class="p">:</span> <span class="n">AbstractUnitOfWork</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="n">ligne</span> <span class="o">=</span> <span class="n">LigneDeCommande</span><span class="p">(</span><span class="n">id_commande</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">id_commande</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">sku</span><span class="p">,</span> <span class="n">quantité</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">quantité</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>        <span class="n">produit</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">produits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">cmd</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>        <span class="k">if</span> <span class="n">produit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>            <span class="k">raise</span> <span class="n">SkuInconnu</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SKU inconnu : </span><span class="si">{</span><span class="n">cmd</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>        <span class="n">réf_lot</span> <span class="o">=</span> <span class="n">produit</span><span class="o">.</span><span class="n">allouer</span><span class="p">(</span><span class="n">ligne</span><span class="p">)</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="k">return</span> <span class="n">réf_lot</span>
</code></pre></div>
<p>Les règles sont simples :</p>
<ul>
<li><code>with uow:</code> ouvre la transaction et initialise le repository</li>
<li><code>uow.produits</code> donne accès au repository (sans savoir comment il est construit)</li>
<li><code>uow.commit()</code> valide la transaction</li>
<li>Si une exception survient avant le commit, <code>__exit__</code> déclenche un <strong>rollback automatique</strong></li>
<li>La session est fermée dans tous les cas</li>
</ul>
<hr />
<h2 id="linterface-abstraite-abstractunitofwork">L'interface abstraite : <code>AbstractUnitOfWork</code><a class="headerlink" href="#linterface-abstraite-abstractunitofwork" title="Permanent link">&para;</a></h2>
<p>L'interface est définie comme une classe abstraite qui implémente le <strong>context manager protocol</strong> de Python -- c'est-à-dire les méthodes <code>__enter__</code> et <code>__exit__</code>.</p>
<div class="highlight"><span class="filename">src/allocation/service_layer/unit_of_work.py</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AbstractUnitOfWork</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="sd">    Interface abstraite du Unit of Work.</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="hll"><span class="sd">    Définit le contrat : un repository produits,</span>
</span><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="sd">    et les méthodes commit/rollback.</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="hll">
</span><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="n">produits</span><span class="p">:</span> <span class="n">repository</span><span class="o">.</span><span class="n">AbstractRepository</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractUnitOfWork</span><span class="p">:</span>
</span><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="hll">
</span><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div>
<h3 id="anatomie-du-context-manager-protocol">Anatomie du context manager protocol<a class="headerlink" href="#anatomie-du-context-manager-protocol" title="Permanent link">&para;</a></h3>
<p>Le protocol <code>with</code> de Python repose sur deux méthodes spéciales :</p>
<table>
<thead>
<tr>
<th>Méthode</th>
<th>Quand ?</th>
<th>Rôle dans le UoW</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__enter__</code></td>
<td>À l'entrée du bloc <code>with</code></td>
<td>Retourne <code>self</code> pour le <code>as</code></td>
</tr>
<tr>
<td><code>__exit__</code></td>
<td>À la sortie du bloc <code>with</code> (toujours)</td>
<td>Rollback automatique en cas d'erreur</td>
</tr>
</tbody>
</table>
<p>Le point crucial est que <code>__exit__</code> est <strong>toujours appelé</strong>, même si une exception a lieu. C'est ce qui garantit le rollback automatique : si <code>commit()</code> n'a pas été appelé explicitement, <code>__exit__</code> appelle <code>rollback()</code>.</p>
<div class="admonition note">
<p class="admonition-title">Pourquoi <code>_commit</code> avec un underscore ?</p>
<p>La méthode publique <code>commit()</code> est définie dans la classe abstraite. Elle délègue à <code>_commit()</code>, la méthode abstraite que les sous-classes implémentent. Ce découpage permet d'ajouter de la logique commune dans <code>commit()</code> (par exemple collecter les events) sans que chaque implémentation doive y penser.</p>
</div>
<hr />
<h2 id="limplementation-sqlalchemy">L'implémentation SQLAlchemy<a class="headerlink" href="#limplementation-sqlalchemy" title="Permanent link">&para;</a></h2>
<p>Voici l'implémentation concrète qui utilise SQLAlchemy :</p>
<div class="highlight"><span class="filename">src/allocation/service_layer/unit_of_work.py</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">DEFAULT_SESSION_FACTORY</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="n">bind</span><span class="o">=</span><span class="n">create_engine</span><span class="p">(</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>        <span class="s2">&quot;sqlite:///allocation.db&quot;</span><span class="p">,</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="n">isolation_level</span><span class="o">=</span><span class="s2">&quot;SERIALIZABLE&quot;</span><span class="p">,</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="p">)</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="p">)</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">SqlAlchemyUnitOfWork</span><span class="p">(</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="sd">    Implémentation concrète du UoW avec SQLAlchemy.</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="sd">    Gère la session SQLAlchemy et le repository associé.</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_factory</span><span class="p">:</span> <span class="n">sessionmaker</span> <span class="o">=</span> <span class="n">DEFAULT_SESSION_FACTORY</span><span class="p">):</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span> <span class="o">=</span> <span class="n">session_factory</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SqlAlchemyUnitOfWork</span><span class="p">:</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span><span class="p">()</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">produits</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</code></pre></div>
<h3 id="le-cycle-de-vie-de-la-session">Le cycle de vie de la session<a class="headerlink" href="#le-cycle-de-vie-de-la-session" title="Permanent link">&para;</a></h3>
<p>Voici ce qui se passe concrètement lors de l'exécution d'un handler :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>with uow:                          # (1) __enter__ est appelé
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    |                              #     -&gt; session = session_factory()
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    |                              #     -&gt; produits = SqlAlchemyRepository(session)
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    produit = uow.produits.get()   # (2) lecture via la session
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    produit.allouer(ligne)         # (3) logique métier pure
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    uow.commit()                   # (4) session.commit()
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>                                   # (5) __exit__ est appelé
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>                                   #     -&gt; rollback() (sans effet après commit)
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>                                   #     -&gt; session.close()
</code></pre></div>
<p>Trois points importants :</p>
<ol>
<li>
<p><strong>La session est créée à l'entrée</strong> (<code>__enter__</code>), pas dans le constructeur. Cela signifie qu'on peut réutiliser un UoW pour plusieurs transactions successives.</p>
</li>
<li>
<p><strong>Le rollback dans <code>__exit__</code> est un filet de sécurité.</strong> Après un <code>commit()</code> réussi, le <code>rollback()</code> n'a aucun effet. Mais si une exception survient avant le commit, il annule toutes les modifications.</p>
</li>
<li>
<p><strong>La session est toujours fermée</strong> à la sortie, que la transaction ait réussi ou non. Pas de fuite de connexion.</p>
</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Isolation level <code>SERIALIZABLE</code></p>
<p>La session factory utilise le niveau d'isolation <code>SERIALIZABLE</code>, le plus strict. Cela garantit que deux transactions concurrentes ne peuvent pas modifier le même produit simultanément. C'est essentiel pour l'allocation de stock où les conditions de course (race conditions) pourraient mener à de la surallocation.</p>
</div>
<hr />
<h2 id="la-collecte-des-events-collect_new_events">La collecte des events : <code>collect_new_events</code><a class="headerlink" href="#la-collecte-des-events-collect_new_events" title="Permanent link">&para;</a></h2>
<p>Le Unit of Work joue un rôle supplémentaire dans notre architecture : il sert de <strong>pont entre les agrégats et le message bus</strong>.</p>
<p>Quand un agrégat effectue une opération métier, il peut émettre des domain events. Par exemple, <code>Produit.allouer()</code> émet un event <code>RuptureDeStock</code> si le stock est épuisé, et <code>Produit.modifier_quantité_lot()</code> émet des events <code>Désalloué</code> pour les lignes à réallouer.</p>
<p>Le problème est : <strong>comment le message bus récupère-t-il ces events ?</strong></p>
<p>C'est la méthode <code>collect_new_events()</code> du UoW qui s'en charge :</p>
<div class="highlight"><span class="filename">src/allocation/service_layer/unit_of_work.py</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">collect_new_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="sd">    Collecte tous les événements émis par les agrégats vus</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="sd">    au cours de cette transaction.</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="k">for</span> <span class="n">produit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">produits</span><span class="o">.</span><span class="n">seen</span><span class="p">:</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>        <span class="k">while</span> <span class="n">produit</span><span class="o">.</span><span class="n">événements</span><span class="p">:</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>            <span class="k">yield</span> <span class="n">produit</span><span class="o">.</span><span class="n">événements</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<h3 id="comment-ca-fonctionne">Comment ça fonctionne<a class="headerlink" href="#comment-ca-fonctionne" title="Permanent link">&para;</a></h3>
<p>Le mécanisme repose sur la collaboration entre le repository et le UoW :</p>
<ol>
<li>Le repository garde une trace de tous les agrégats qu'il a <strong>vus</strong> (via <code>add</code> ou <code>get</code>), dans son attribut <code>seen</code>.</li>
<li>Chaque agrégat <code>Produit</code> maintient une liste <code>événements</code> où il accumule ses domain events.</li>
<li>Après chaque handler, le message bus appelle <code>uow.collect_new_events()</code>.</li>
<li>Cette méthode itère sur les agrégats vus et <strong>vide</strong> leur liste <code>événements</code> (avec <code>pop</code>).</li>
<li>Les events récupérés sont réinjectés dans la queue du message bus pour être traités à leur tour.</li>
</ol>
<div class="highlight"><span class="filename">src/allocation/service_layer/messagebus.py (extrait)</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_handle_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">commands</span><span class="o">.</span><span class="n">Command</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uow</span><span class="o">.</span><span class="n">collect_new_events</span><span class="p">())</span>  <span class="c1"># (1)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<ol>
<li>Après chaque command, le bus collecte les events émis et les ajoute à sa queue.</li>
</ol>
<p>C'est un mécanisme élégant : les agrégats n'ont pas besoin de connaître le message bus, le bus n'a pas besoin de connaître le domaine, et le UoW fait le lien entre les deux.</p>
<hr />
<h2 id="le-fake-unit-of-work-pour-les-tests">Le Fake Unit of Work pour les tests<a class="headerlink" href="#le-fake-unit-of-work-pour-les-tests" title="Permanent link">&para;</a></h2>
<p>L'un des avantages majeurs du pattern est la <strong>testabilité</strong>. Puisque les handlers dépendent de <code>AbstractUnitOfWork</code> (une abstraction), on peut facilement le remplacer par un fake dans les tests unitaires. Le <code>FakeUnitOfWork</code> utilise un <code>FakeRepository</code> qui stocke les produits en mémoire (un simple <code>set</code>) :</p>
<div class="highlight"><span class="filename">tests/unit/test_handlers.py</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">FakeUnitOfWork</span><span class="p">(</span><span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="sd">    Fake Unit of Work utilisant le FakeRepository.</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="sd">    Permet de tester sans base de données.</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">produits</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([])</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># (1)</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>        <span class="k">pass</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># (2)</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>        <span class="k">pass</span>
</code></pre></div>
<ol>
<li>L'attribut <code>committed</code> est initialisé à <code>False</code>.</li>
<li>Quand <code>commit()</code> est appelé (via <code>_commit</code>), il passe à <code>True</code>.</li>
</ol>
<h3 id="lattribut-committed-verifier-latomicite">L'attribut <code>committed</code> : vérifier l'atomicité<a class="headerlink" href="#lattribut-committed-verifier-latomicite" title="Permanent link">&para;</a></h3>
<p>L'attribut <code>committed</code> est un outil de test simple mais puissant. Il permet de <strong>vérifier que le handler a bien commité la transaction</strong> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestAjouterLot</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_ajouter_un_lot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>        <span class="n">bus</span> <span class="o">=</span> <span class="n">bootstrap_test_bus</span><span class="p">()</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>        <span class="n">bus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">CréerLot</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;COUSSIN-CARRE&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="k">assert</span> <span class="n">bus</span><span class="o">.</span><span class="n">uow</span><span class="o">.</span><span class="n">produits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COUSSIN-CARRE&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="k">assert</span> <span class="n">bus</span><span class="o">.</span><span class="n">uow</span><span class="o">.</span><span class="n">committed</span>  <span class="c1"># on vérifie que le commit a eu lieu</span>
</code></pre></div>
<p>Sans cet attribut, on ne pourrait pas distinguer un handler qui modifie le repository sans commiter (ce qui serait un bug) d'un handler qui commite correctement.</p>
<h3 id="le-fakerepository-et-lattribut-seen">Le <code>FakeRepository</code> et l'attribut <code>seen</code><a class="headerlink" href="#le-fakerepository-et-lattribut-seen" title="Permanent link">&para;</a></h3>
<p>Le <code>FakeRepository</code> hérite de <code>AbstractRepository</code>, qui définit l'attribut <code>seen</code>. Cela signifie que <code>collect_new_events()</code> fonctionne <strong>exactement de la même manière</strong> avec le fake qu'avec l'implémentation réelle. Les tests unitaires vérifient donc le comportement complet, y compris la propagation des events.</p>
<div class="admonition tip">
<p class="admonition-title">Le pattern général des fakes</p>
<p>Un bon fake implémente la même interface que le composant réel, avec un stockage en mémoire. Il peut aussi exposer des attributs supplémentaires (comme <code>committed</code>) pour les assertions. C'est plus fiable qu'un mock car on teste le <strong>comportement</strong> réel de l'interface, pas juste les appels de méthodes.</p>
</div>
<hr />
<h2 id="le-flux-complet-du-handler-au-domaine">Le flux complet : du handler au domaine<a class="headerlink" href="#le-flux-complet-du-handler-au-domaine" title="Permanent link">&para;</a></h2>
<p>Voici le flux complet quand le message bus traite une command <code>Allouer</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>MessageBus.handle(Allouer)
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    |
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    v
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>handler: allouer(cmd, uow)
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    |
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    +---&gt; with uow:                          # UoW.__enter__
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    |         |                               #   crée session + repository
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    |         +---&gt; uow.produits.get(sku)     # Repository.get()
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    |         |         |                     #   marque le Produit comme &quot;seen&quot;
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    |         |         v
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    |         +---&gt; produit.allouer(ligne)    # Logique métier pure
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    |         |         |                     #   peut émettre des events
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    |         |         v
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>    |         +---&gt; uow.commit()              # UoW.commit()
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>    |                   |                     #   session.commit()
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    |                   v
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>    +---&gt; (sortie du with)                    # UoW.__exit__
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>              |                               #   rollback() + session.close()
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>              v
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>MessageBus: uow.collect_new_events()          # Collecte les events
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>    |                                         #   émis par les agrégats &quot;seen&quot;
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>    v
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>Traitement des events suivants...
</code></pre></div>
<p>Le diagramme en couches correspondant :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>+------------------------------------------------------+
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>|                    Message Bus                        |
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>|   handle(command) -&gt; handler -&gt; collect_new_events()  |
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>+------------------------------------------------------+
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>          |                          ^
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>          v                          |
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>+------------------------------------------------------+
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>|                   Unit of Work                        |
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>|   __enter__  |  commit  |  rollback  |  __exit__     |
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>|   fournit: repository (produits)                     |
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>+------------------------------------------------------+
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>          |                          ^
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>          v                          |
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>+------------------------------------------------------+
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>|                    Repository                         |
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>|   add(produit)  |  get(sku)  |  seen: set[Produit]   |
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>+------------------------------------------------------+
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>          |                          ^
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>          v                          |
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>+------------------------------------------------------+
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>|               Modèle de Domaine                       |
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>|   Produit -&gt; Lot -&gt; LigneDeCommande                   |
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>|   événements: [RuptureDeStock, Désalloué, ...]       |
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>+------------------------------------------------------+
</code></pre></div>
<hr />
<h2 id="resume">Résumé<a class="headerlink" href="#resume" title="Permanent link">&para;</a></h2>
<p>Le pattern <strong>Unit of Work</strong> résout le problème de la gestion des transactions en introduisant un objet qui encapsule la session, le repository et la logique de commit/rollback.</p>
<h3 id="ce-que-le-unit-of-work-apporte">Ce que le Unit of Work apporte<a class="headerlink" href="#ce-que-le-unit-of-work-apporte" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Sans UoW</th>
<th>Avec UoW</th>
</tr>
</thead>
<tbody>
<tr>
<td>Transaction</td>
<td>Gérée par le handler ou le repository</td>
<td>Encapsulée dans le context manager</td>
</tr>
<tr>
<td>Atomicité</td>
<td>Difficile à garantir</td>
<td>Garantie par <code>__enter__</code>/<code>__exit__</code></td>
</tr>
<tr>
<td>Couplage</td>
<td>Handler couplé à SQLAlchemy</td>
<td>Handler dépend d'une abstraction</td>
</tr>
<tr>
<td>Testabilité</td>
<td>Nécessite une base de données</td>
<td>Fake UoW en mémoire</td>
</tr>
<tr>
<td>Collecte des events</td>
<td>Pas de mécanisme standard</td>
<td><code>collect_new_events()</code> centralisé</td>
</tr>
</tbody>
</table>
<h3 id="les-fichiers-cles">Les fichiers clés<a class="headerlink" href="#les-fichiers-cles" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Fichier</th>
<th>Rôle</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>src/allocation/service_layer/unit_of_work.py</code></td>
<td>Interface abstraite et implémentation SQLAlchemy</td>
</tr>
<tr>
<td><code>src/allocation/adapters/repository.py</code></td>
<td>Repository avec tracking des agrégats vus (<code>seen</code>)</td>
</tr>
<tr>
<td><code>src/allocation/service_layer/handlers.py</code></td>
<td>Handlers qui utilisent le UoW comme context manager</td>
</tr>
<tr>
<td><code>tests/unit/test_handlers.py</code></td>
<td><code>FakeUnitOfWork</code> et <code>FakeRepository</code> pour les tests</td>
</tr>
</tbody>
</table>
<h3 id="les-principes-a-retenir">Les principes à retenir<a class="headerlink" href="#les-principes-a-retenir" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Le UoW est un context manager</strong> qui gère le cycle de vie de la transaction : ouverture, commit, rollback, fermeture.</li>
<li><strong>Le handler ne connaît que l'abstraction</strong> (<code>AbstractUnitOfWork</code>), jamais SQLAlchemy directement.</li>
<li><strong>Le rollback est automatique</strong> : si <code>commit()</code> n'est pas appelé explicitement, <code>__exit__</code> annule tout.</li>
<li><strong>Le UoW collecte les events</strong> émis par les agrégats au cours de la transaction, servant de pont vers le message bus.</li>
<li><strong>Le <code>FakeUnitOfWork</code> rend les tests rapides</strong> et déterministes, sans base de données.</li>
</ol>
<h2 id="exercices">Exercices<a class="headerlink" href="#exercices" title="Permanent link">&para;</a></h2>
<div class="admonition example">
<p class="admonition-title">Exercice 1 -- UoW avec rollback explicite</p>
<p>Modifiez le <code>FakeUnitOfWork</code> pour que <code>rollback()</code> vide le <code>FakeRepository</code>. Écrivez un test qui vérifie qu'après un rollback, les produits ajoutés pendant la transaction ont disparu.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Exercice 2 -- Double commit</p>
<p>Que se passe-t-il si un handler appelle <code>uow.commit()</code> deux fois ? Et si <code>commit()</code> n'est jamais appelé ? Écrivez des tests pour vérifier chaque scénario.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Exercice 3 -- UoW sans context manager</p>
<p>Essayez d'utiliser le <code>SqlAlchemyUnitOfWork</code> sans <code>with</code> (en appelant manuellement <code>__enter__</code> et <code>__exit__</code>). Quels risques cela crée-t-il ? Pourquoi le context manager est-il préférable ?</p>
</div>
<hr />
<div class="admonition abstract">
<p class="admonition-title">Dans le prochain chapitre</p>
<p>Nous verrons le pattern <strong>Aggregate</strong> et la notion de <strong>frontière de cohérence</strong>. L'agrégat <code>Produit</code> définit le périmètre à l'intérieur duquel les invariants métier sont garantis -- et le Unit of Work commite exactement un agrégat par transaction.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "content.code.annotate", "navigation.sections", "navigation.expand", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>