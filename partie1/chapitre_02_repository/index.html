
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Guide francophone des patterns d'architecture logicielle en Python">
      
      
      
      
        <link rel="prev" href="../chapitre_01_modele_domaine/">
      
      
        <link rel="next" href="../chapitre_03_abstractions/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>Chapitre 2 - Le pattern Repository - Patterns d'Architecture en Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapitre-2-le-pattern-repository" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href="../.." title="Patterns d&#39;Architecture en Python" class="md-header__button md-logo" aria-label="Patterns d'Architecture en Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Patterns d'Architecture en Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapitre 2 - Le pattern Repository
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Recherche">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/chris-lmd/cosmic-python-fr" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    chris-lmd/cosmic-python-fr
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Patterns d&#39;Architecture en Python" class="md-nav__button md-logo" aria-label="Patterns d'Architecture en Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Patterns d'Architecture en Python
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/chris-lmd/cosmic-python-fr" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    chris-lmd/cosmic-python-fr
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapitre_00_mise_en_route/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 0 - Mise en route
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Partie 1 - Construire une architecture pour le Domain Modeling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Partie 1 - Construire une architecture pour le Domain Modeling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_01_modele_domaine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 1 - Le modèle de domaine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 2 - Le pattern Repository
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 2 - Le pattern Repository
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#le-probleme-de-la-persistance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le problème de la persistance
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-pattern-repository" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le pattern Repository
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-port-linterface-abstraite" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le port : l'interface abstraite
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Le port : l&#39;interface abstraite">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#methodes-publiques-et-methodes-abstraites-protegees" class="md-nav__link">
    <span class="md-ellipsis">
      
        Méthodes publiques et méthodes abstraites protégées
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lattribut-seen" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'attribut seen
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#le-vocabulaire-ports-and-adapters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le vocabulaire Ports and Adapters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ladapter-concret-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'adapter concret : SQLAlchemy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistence-ignorance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Persistence Ignorance
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistence Ignorance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comment-ca-marche-alors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comment ça marche alors ?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependency-inversion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dependency Inversion
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dependency Inversion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#approche-classique-dependance-directe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Approche classique (dépendance directe)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notre-approche-dependance-inversee" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notre approche (dépendance inversée)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fake-repository-pour-les-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fake Repository pour les tests
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fake Repository pour les tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pourquoi-cest-puissant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pourquoi c'est puissant
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-schema-densemble" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le schéma d'ensemble
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Exercices
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resume" class="md-nav__link">
    <span class="md-ellipsis">
      
        Résumé
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Résumé">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tableau-des-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tableau des concepts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avantages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Avantages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inconvenients" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inconvénients
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_03_abstractions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 3 - Couplage et abstractions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_04_service_layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 4 - La Service Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_05_tdd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 5 - TDD à haute et basse vitesse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_06_unit_of_work/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 6 - Le pattern Unit of Work
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_07_aggregats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 7 - Agrégats et frontières de cohérence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Partie 2 - Architecture événementielle
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Partie 2 - Architecture événementielle
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_08_events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 8 - Events et le Message Bus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_09_message_bus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 9 - Aller plus loin avec le Message Bus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_10_commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 10 - Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_11_events_externes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 11 - Events externes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_12_cqrs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 12 - CQRS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_13_injection_dependances/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 13 - Injection de dépendances
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../epilogue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Épilogue
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#le-probleme-de-la-persistance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le problème de la persistance
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-pattern-repository" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le pattern Repository
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-port-linterface-abstraite" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le port : l'interface abstraite
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Le port : l&#39;interface abstraite">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#methodes-publiques-et-methodes-abstraites-protegees" class="md-nav__link">
    <span class="md-ellipsis">
      
        Méthodes publiques et méthodes abstraites protégées
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lattribut-seen" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'attribut seen
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#le-vocabulaire-ports-and-adapters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le vocabulaire Ports and Adapters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ladapter-concret-sqlalchemy" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'adapter concret : SQLAlchemy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistence-ignorance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Persistence Ignorance
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistence Ignorance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comment-ca-marche-alors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comment ça marche alors ?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependency-inversion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dependency Inversion
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dependency Inversion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#approche-classique-dependance-directe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Approche classique (dépendance directe)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notre-approche-dependance-inversee" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notre approche (dépendance inversée)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fake-repository-pour-les-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fake Repository pour les tests
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fake Repository pour les tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pourquoi-cest-puissant" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pourquoi c'est puissant
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-schema-densemble" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le schéma d'ensemble
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Exercices
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resume" class="md-nav__link">
    <span class="md-ellipsis">
      
        Résumé
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Résumé">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tableau-des-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tableau des concepts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avantages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Avantages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inconvenients" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inconvénients
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="chapitre-2-le-pattern-repository">Chapitre 2 -- Le pattern Repository<a class="headerlink" href="#chapitre-2-le-pattern-repository" title="Permanent link">&para;</a></h1>
<h2 id="le-probleme-de-la-persistance">Le problème de la persistance<a class="headerlink" href="#le-probleme-de-la-persistance" title="Permanent link">&para;</a></h2>
<p>Au chapitre précédent, nous avons construit un modèle de domaine riche : des <code>LigneDeCommande</code>, des <code>Lot</code>, une fonction <code>allouer()</code> avec des règles métier claires. Tout fonctionne en mémoire, les tests passent, la logique est pure.</p>
<p>Pour persister ces objets, nous avons besoin d'un <strong>conteneur</strong> qui regroupe les lots d'un même SKU. C'est le rôle de la classe <code>Produit</code> : un objet simple qui possède un <code>sku</code> et une liste de <code>lots</code>. Nous verrons au <a href="../chapitre_07_aggregats/">chapitre 7</a> pourquoi ce conteneur est en réalité un <strong>Agrégat</strong> au sens du DDD, mais pour l'instant, il suffit de le voir comme un regroupement pratique.</p>
<p>Mais une application réelle doit <strong>sauvegarder ses données</strong>. Les objets du domaine doivent être persistés dans une base de données, puis rechargées plus tard. Et c'est là que les ennuis commencent.</p>
<p>La tentation naturelle est d'ajouter des méthodes <code>save()</code> et <code>load()</code> directement dans le modèle de domaine :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Ce qu&#39;on veut éviter</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Produit</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO products ...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sku</span><span class="p">):</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>        <span class="n">row</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM products WHERE sku = ?&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>
<p>Ce code mélange deux responsabilités : la logique métier et l'accès aux données. Le modèle de domaine, qui était pur et testable, devient soudain dépendant de la base de données.</p>
<div class="admonition danger">
<p class="admonition-title">Le piège</p>
<p>Si le modèle de domaine connaît la BDD, chaque test unitaire devra instancier une connexion. Les tests deviennent lents, fragiles, et difficiles à maintenir.</p>
</div>
<p>La question est donc : <strong>comment persister les objets du domaine sans polluer le modèle ?</strong></p>
<p>La réponse : le pattern Repository.</p>
<h2 id="le-pattern-repository">Le pattern Repository<a class="headerlink" href="#le-pattern-repository" title="Permanent link">&para;</a></h2>
<p>Le Repository est une abstraction qui donne <strong>l'illusion d'une collection d'objets en mémoire</strong>. Du point de vue du code qui l'utilise, un repository ressemble à un simple <code>set</code> ou une <code>list</code> Python : on peut y ajouter des objets, en récupérer, sans jamais se soucier de la façon dont ils sont stockés.</p>
<p>L'interface est volontairement minimale :</p>
<ul>
<li><strong><code>add(produit)</code></strong> -- ajouter un nouvel agrégat</li>
<li><strong><code>get(sku)</code></strong> -- récupérer un agrégat existant par son identifiant</li>
</ul>
<p>C'est tout. Pas de <code>save()</code>, pas de <code>update()</code>, pas de <code>delete()</code>. Le repository cache toute la complexité de la persistance derrière cette interface élémentaire.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Code métier                    Repository                     BDD
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>-----------                    ----------                     ---
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>                  add(produit)                  INSERT INTO ...
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>produit = repo ───────────────&gt; repo ─────────────────────────&gt; DB
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>                  get(sku)                     SELECT * FROM ...
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>produit = repo &lt;─────────────── repo &lt;───────────────────────── DB
</code></pre></div>
<p>Le domaine ne sait pas <strong>comment</strong> les objets sont stockés. PostgreSQL ? SQLite ? Un fichier JSON ? Un service distant ? Peu importe. Le contrat est le même.</p>
<h2 id="le-port-linterface-abstraite">Le port : l'interface abstraite<a class="headerlink" href="#le-port-linterface-abstraite" title="Permanent link">&para;</a></h2>
<p>Dans notre projet, le port est défini par la classe <code>AbstractRepository</code>. C'est une classe abstraite qui établit le contrat que toute implémentation doit respecter.</p>
<p>Voici le code de <code>src/allocation/adapters/repository.py</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">allocation.domain</span><span class="w"> </span><span class="kn">import</span> <span class="n">model</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">AbstractRepository</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="sd">    Interface abstraite du repository.</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="sd">    Définit le contrat que tout repository doit respecter.</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="sd">    Le pattern repose sur deux opérations fondamentales :</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="sd">    - add : ajouter un nouvel agrégat</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="sd">    - get : récupérer un agrégat existant</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">]</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">produit</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ajoute un produit au repository et le marque comme vu.&quot;&quot;&quot;</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">produit</span><span class="p">)</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">produit</span><span class="p">)</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Récupère un produit par son SKU et le marque comme vu.&quot;&quot;&quot;</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>        <span class="n">produit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">sku</span><span class="p">)</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>        <span class="k">if</span> <span class="n">produit</span><span class="p">:</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">produit</span><span class="p">)</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>        <span class="k">return</span> <span class="n">produit</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_par_réf_lot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">réf_lot</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Récupère le produit contenant le lot de référence donnée.&quot;&quot;&quot;</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>        <span class="n">produit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_par_réf_lot</span><span class="p">(</span><span class="n">réf_lot</span><span class="p">)</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="k">if</span> <span class="n">produit</span><span class="p">:</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">produit</span><span class="p">)</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>        <span class="k">return</span> <span class="n">produit</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">produit</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_par_réf_lot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">réf_lot</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div>
<p>Analysons les choix de conception :</p>
<h3 id="methodes-publiques-et-methodes-abstraites-protegees">Méthodes publiques et méthodes abstraites protégées<a class="headerlink" href="#methodes-publiques-et-methodes-abstraites-protegees" title="Permanent link">&para;</a></h3>
<p>Les méthodes publiques (<code>add</code>, <code>get</code>, <code>get_par_réf_lot</code>) ne sont <strong>pas</strong> abstraites. Elles contiennent la logique commune à toutes les implémentations -- en l'occurrence, le suivi des objets dans <code>self.seen</code>. Les méthodes abstraites préfixées d'un underscore (<code>_add</code>, <code>_get</code>, <code>_get_par_réf_lot</code>) sont les points d'extension que chaque implémentation concrète doit fournir.</p>
<p>Ce pattern (parfois appelé <strong>Template Method</strong>) garantit que le comportement de suivi est appliqué uniformément, quelle que soit l'implémentation.</p>
<h3 id="lattribut-seen">L'attribut <code>seen</code><a class="headerlink" href="#lattribut-seen" title="Permanent link">&para;</a></h3>
<p>L'ensemble <code>seen</code> trace tous les objets qui ont été ajoutés ou consultés via le repository. Cet attribut est crucial pour le pattern Unit of Work (que nous verrons au chapitre 6) : il permet de savoir quels agrégats ont été manipulés au cours d'une transaction, et donc quels events doivent être collectés et traités.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">produit</span><span class="p">)</span>          <span class="c1"># produit est ajouté à seen</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">produit</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SKU&quot;</span><span class="p">)</span>  <span class="c1"># produit est ajouté à seen</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># -&gt; self.seen contient tous les agrégats touchés</span>
</code></pre></div>
<h3 id="le-vocabulaire-ports-and-adapters">Le vocabulaire Ports and Adapters<a class="headerlink" href="#le-vocabulaire-ports-and-adapters" title="Permanent link">&para;</a></h3>
<p>Dans l'architecture <strong>Ports and Adapters</strong> (aussi appelée architecture hexagonale), un <strong>port</strong> est une interface que le domaine définit pour communiquer avec le monde extérieur. <code>AbstractRepository</code> est un port : il exprime ce que le domaine <strong>attend</strong> de la couche de persistance, sans dicter comment l'implémenter.</p>
<div class="admonition info">
<p class="admonition-title">Port = interface définie par le domaine</p>
<p>Le port appartient au domaine. C'est le domaine qui dicte le contrat : "Je veux pouvoir ajouter un <code>Produit</code> et en récupérer un par son SKU." La couche infrastructure doit s'y conformer.</p>
</div>
<h2 id="ladapter-concret-sqlalchemy">L'adapter concret : SQLAlchemy<a class="headerlink" href="#ladapter-concret-sqlalchemy" title="Permanent link">&para;</a></h2>
<p>Un <strong>adapter</strong> est une implémentation concrète d'un port. Il fait le lien entre l'abstraction définie par le domaine et une technologie spécifique. Dans notre cas, <code>SqlAlchemyRepository</code> est l'adapter qui connecte le port <code>AbstractRepository</code> à une base de données via SQLAlchemy.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">allocation.domain</span><span class="w"> </span><span class="kn">import</span> <span class="n">model</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">SqlAlchemyRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">):</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="sd">    Implémentation concrète du repository avec SQLAlchemy.</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="sd">    Utilise une session SQLAlchemy pour persister et récupérer</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="sd">    les agrégats Produit.</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">produit</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">produit</span><span class="p">)</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">)</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="p">)</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_par_réf_lot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">réf_lot</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">)</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lot</span><span class="p">)</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Lot</span><span class="o">.</span><span class="n">référence</span> <span class="o">==</span> <span class="n">réf_lot</span><span class="p">)</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="p">)</span>
</code></pre></div>
<p>Quelques observations :</p>
<ol>
<li><strong>L'appel à <code>super().__init__()</code></strong> initialise le <code>set</code> <code>seen</code> dans la classe parente.</li>
<li><strong><code>_add</code></strong> délègue simplement à <code>session.add()</code> de SQLAlchemy. La session se charge du tracking et de l'insertion.</li>
<li><strong><code>_get</code></strong> utilise l'API de requêtage de SQLAlchemy pour filtrer par SKU.</li>
<li><strong><code>_get_par_réf_lot</code></strong> fait une jointure pour trouver le <code>Produit</code> à partir d'une référence de lot.</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Adapter = implémentation concrète du port</p>
<p>L'adapter traduit les opérations abstraites du port en appels concrets à une technologie. Si demain on migre vers MongoDB, on écrit un <code>MongoRepository</code> qui implémente les mêmes méthodes <code>_add</code>, <code>_get</code>, <code>_get_par_réf_lot</code>. Le reste du code ne change pas.</p>
</div>
<h2 id="persistence-ignorance">Persistence Ignorance<a class="headerlink" href="#persistence-ignorance" title="Permanent link">&para;</a></h2>
<p>Un principe fondamental de cette architecture est la <strong>Persistence Ignorance</strong> : le modèle de domaine ne sait absolument rien de la base de données. Il n'importe pas SQLAlchemy, ne connaît pas les tables, n'a pas de méthodes <code>save()</code>.</p>
<p>Regardez la classe <code>Produit</code> dans <code>src/allocation/domain/model.py</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Produit</span><span class="p">:</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="sd">    Agrégat racine pour la gestion des produits.</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Lot</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>                 <span class="n">numéro_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lots</span> <span class="o">=</span> <span class="n">lots</span> <span class="ow">or</span> <span class="p">[]</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">numéro_version</span> <span class="o">=</span> <span class="n">numéro_version</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">événements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">events</span><span class="o">.</span><span class="n">Event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">allouer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ligne</span><span class="p">:</span> <span class="n">LigneDeCommande</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="c1"># ... logique métier pure ...</span>
</code></pre></div>
<p>Aucune référence à la BDD. Aucun import de SQLAlchemy. La classe <code>Produit</code> est un objet Python ordinaire, testable en isolation totale.</p>
<h3 id="comment-ca-marche-alors">Comment ça marche alors ?<a class="headerlink" href="#comment-ca-marche-alors" title="Permanent link">&para;</a></h3>
<p>C'est le module <code>src/allocation/adapters/orm.py</code> qui fait le lien, en utilisant le <strong>classical mapping</strong> de SQLAlchemy. Ce mécanisme permet de définir les tables d'un côté, les classes du domaine de l'autre, et de les associer explicitement :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Table</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">registry</span><span class="p">,</span> <span class="n">relationship</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">allocation.domain</span><span class="w"> </span><span class="kn">import</span> <span class="n">model</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="n">mapper_registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="c1"># Définition des tables</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="n">order_lines</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    <span class="s2">&quot;order_lines&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id_commande&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;sku&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;quantite&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="p">)</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="n">products</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="s2">&quot;products&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;sku&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;numero_version&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">),</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="n">batches</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>    <span class="s2">&quot;batches&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;reference&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;sku&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;quantite_achetee&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;eta&quot;</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;product_sku&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;products.sku&quot;</span><span class="p">)),</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="p">)</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="n">allocations</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>    <span class="s2">&quot;allocations&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;orderline_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;order_lines.id&quot;</span><span class="p">)),</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;batch_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;batches.id&quot;</span><span class="p">)),</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="p">)</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="k">def</span><span class="w"> </span><span class="nf">start_mappers</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="sd">    Configure le mapping entre les classes du domaine et les tables SQL.</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>    <span class="n">lines_mapper</span> <span class="o">=</span> <span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>        <span class="n">model</span><span class="o">.</span><span class="n">LigneDeCommande</span><span class="p">,</span> <span class="n">order_lines</span><span class="p">,</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>        <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>            <span class="s2">&quot;id_commande&quot;</span><span class="p">:</span> <span class="n">order_lines</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id_commande</span><span class="p">,</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>            <span class="s2">&quot;quantité&quot;</span><span class="p">:</span> <span class="n">order_lines</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantite</span><span class="p">,</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>        <span class="p">},</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>    <span class="p">)</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>    <span class="n">batches_mapper</span> <span class="o">=</span> <span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>        <span class="n">model</span><span class="o">.</span><span class="n">Lot</span><span class="p">,</span> <span class="n">batches</span><span class="p">,</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>        <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>            <span class="s2">&quot;référence&quot;</span><span class="p">:</span> <span class="n">batches</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>            <span class="s2">&quot;_quantité_achetée&quot;</span><span class="p">:</span> <span class="n">batches</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantite_achetee</span><span class="p">,</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>            <span class="s2">&quot;_allocations&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>                <span class="n">lines_mapper</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">allocations</span><span class="p">,</span> <span class="n">collection_class</span><span class="o">=</span><span class="nb">set</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>            <span class="p">),</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>        <span class="p">},</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>    <span class="p">)</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>    <span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>        <span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">,</span> <span class="n">products</span><span class="p">,</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>        <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>            <span class="s2">&quot;numéro_version&quot;</span><span class="p">:</span> <span class="n">products</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">numero_version</span><span class="p">,</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>            <span class="s2">&quot;lots&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>                <span class="n">batches_mapper</span><span class="p">,</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>                <span class="n">primaryjoin</span><span class="o">=</span><span class="p">(</span><span class="n">products</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">batches</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">product_sku</span><span class="p">),</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>            <span class="p">),</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>        <span class="p">},</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>    <span class="p">)</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Classical mapping vs. declarative</p>
<p>L'approche classique de SQLAlchemy (utilisée ici via <code>map_imperatively</code>) est plus verbeuse que l'approche déclarative (où les classes héritent de <code>Base</code>), mais elle a un avantage crucial : <strong>le modèle de domaine reste totalement indépendant de l'ORM</strong>. Les classes <code>Produit</code>, <code>Lot</code> et <code>LigneDeCommande</code> n'héritent d'aucune classe SQLAlchemy.</p>
</div>
<p>La fonction <code>start_mappers()</code> est appelée une seule fois au démarrage de l'application. À partir de ce moment, SQLAlchemy sait comment convertir les objets du domaine en lignes de table, et inversement.</p>
<h2 id="dependency-inversion">Dependency Inversion<a class="headerlink" href="#dependency-inversion" title="Permanent link">&para;</a></h2>
<p>Le pattern Repository illustre parfaitement le <strong>principe d'inversion des dépendances</strong> (le "D" de SOLID). Comparons deux approches :</p>
<h3 id="approche-classique-dependance-directe">Approche classique (dépendance directe)<a class="headerlink" href="#approche-classique-dependance-directe" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Domaine ──depends on──&gt; Infrastructure (SQLAlchemy)
</code></pre></div>
<p>Le domaine importe et utilise directement SQLAlchemy. Il est couplé à une technologie spécifique.</p>
<h3 id="notre-approche-dependance-inversee">Notre approche (dépendance inversée)<a class="headerlink" href="#notre-approche-dependance-inversee" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Domaine ──définit──&gt; AbstractRepository (port)
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>                           ^
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>                           |
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>                       implémente
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>                           |
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>Infrastructure ────&gt; SqlAlchemyRepository (adapter)
</code></pre></div>
<p>Le domaine définit l'interface (<code>AbstractRepository</code>). L'infrastructure l'implémente (<code>SqlAlchemyRepository</code>). Les dépendances pointent <strong>vers l'intérieur</strong>, vers le domaine.</p>
<div class="admonition success">
<p class="admonition-title">Conséquence</p>
<p>Le domaine ne dépend de rien. C'est l'infrastructure qui dépend du domaine. Si on veut changer de base de données, on ne touche pas au domaine -- on écrit un nouvel adapter.</p>
</div>
<p>Ce principe se généralise à toute communication avec le monde extérieur : envoyer un email, appeler une API, lire un fichier. Le domaine définit le port (ce dont il a besoin), et l'infrastructure fournit l'adapter (comment le faire concrètement).</p>
<h2 id="fake-repository-pour-les-tests">Fake Repository pour les tests<a class="headerlink" href="#fake-repository-pour-les-tests" title="Permanent link">&para;</a></h2>
<p>L'un des bénéfices les plus immédiats du pattern Repository est la possibilité de créer un <strong>fake</strong> pour les tests. Puisque le contrat est défini par l'interface abstraite, on peut écrire une implémentation qui stocke tout en mémoire, dans un simple <code>set</code> Python.</p>
<p>Voici le <code>FakeRepository</code> utilisé dans <code>tests/unit/test_handlers.py</code> :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">FakeRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="sd">    Fake repository qui stocke les produits en mémoire.</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="sd">    Utilisé pour les tests unitaires.</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">produits</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_produits</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">produits</span> <span class="ow">or</span> <span class="p">[])</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">produit</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_produits</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">produit</span><span class="p">)</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_produits</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">sku</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_par_réf_lot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">réf_lot</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>            <span class="p">(</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>                <span class="n">p</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_produits</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">lots</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">référence</span> <span class="o">==</span> <span class="n">réf_lot</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>            <span class="p">),</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>            <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        <span class="p">)</span>
</code></pre></div>
<p>C'est tout. Pas de base de données, pas de fichier de configuration, pas de conteneur Docker. Juste un <code>set</code> Python.</p>
<h3 id="pourquoi-cest-puissant">Pourquoi c'est puissant<a class="headerlink" href="#pourquoi-cest-puissant" title="Permanent link">&para;</a></h3>
<p>Les tests qui utilisent le <code>FakeRepository</code> sont :</p>
<ul>
<li><strong>Rapides</strong> -- pas de connexion à une BDD, pas d'I/O. Les tests s'exécutent en millisecondes.</li>
<li><strong>Isolés</strong> -- chaque test crée son propre fake, sans effet de bord.</li>
<li><strong>Déterministes</strong> -- pas de problème d'état partagé, de données résiduelles ou de transactions concurrentes.</li>
<li><strong>Faciles à écrire</strong> -- pas besoin de fixtures complexes pour initialiser la base.</li>
</ul>
<p>Voici un exemple de test concret utilisant le fake :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestAjouterLot</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_ajouter_un_lot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>        <span class="n">bus</span> <span class="o">=</span> <span class="n">bootstrap_test_bus</span><span class="p">()</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>        <span class="n">bus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">CréerLot</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;COUSSIN-CARRE&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="k">assert</span> <span class="n">bus</span><span class="o">.</span><span class="n">uow</span><span class="o">.</span><span class="n">produits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COUSSIN-CARRE&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        <span class="k">assert</span> <span class="n">bus</span><span class="o">.</span><span class="n">uow</span><span class="o">.</span><span class="n">committed</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_ajouter_lot_produit_existant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        <span class="n">bus</span> <span class="o">=</span> <span class="n">bootstrap_test_bus</span><span class="p">()</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        <span class="n">bus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">CréerLot</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;LAMPE-RONDE&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="n">bus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">CréerLot</span><span class="p">(</span><span class="s2">&quot;b2&quot;</span><span class="p">,</span> <span class="s2">&quot;LAMPE-RONDE&quot;</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>        <span class="n">produit</span> <span class="o">=</span> <span class="n">bus</span><span class="o">.</span><span class="n">uow</span><span class="o">.</span><span class="n">produits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LAMPE-RONDE&quot;</span><span class="p">)</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">produit</span><span class="o">.</span><span class="n">lots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>
<p>Le <code>FakeRepository</code> est imbriqué dans un <code>FakeUnitOfWork</code> (que nous détaillerons au chapitre 6), mais le principe est le même : on remplace l'adapter concret par un fake, et le code métier ne voit pas la différence.</p>
<div class="admonition info">
<p class="admonition-title">Fake vs Mock</p>
<p>Un <strong>fake</strong> est une implémentation simplifiée mais fonctionnelle d'une interface. Il a un vrai comportement (ici : stocker et retrouver des objets). Un <strong>mock</strong>, en revanche, se contente de vérifier que certaines méthodes ont été appelées avec certains arguments. Les fakes sont généralement préférables car ils testent le <strong>comportement</strong> plutôt que l'<strong>implémentation</strong>.</p>
</div>
<h2 id="le-schema-densemble">Le schéma d'ensemble<a class="headerlink" href="#le-schema-densemble" title="Permanent link">&para;</a></h2>
<p>Récapitulons comment les pièces s'assemblent :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>src/allocation/
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    domain/
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>        model.py              &lt;-- Modèle de domaine (Produit, Lot, LigneDeCommande)
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>                                   Ne connaît PAS la BDD
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    adapters/
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>        repository.py         &lt;-- AbstractRepository (port)
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>                                   + SqlAlchemyRepository (adapter)
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>        orm.py                &lt;-- Classical mapping SQLAlchemy
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>                                   Fait le lien entre model.py et la BDD
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>tests/unit/
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    test_handlers.py          &lt;-- FakeRepository (fake adapter pour les tests)
</code></pre></div>
<p>Le flux est toujours le même :</p>
<ol>
<li>Le code métier manipule un <code>AbstractRepository</code> (le port).</li>
<li>En production, c'est un <code>SqlAlchemyRepository</code> (l'adapter réel) qui est injecté.</li>
<li>En test, c'est un <code>FakeRepository</code> (le fake adapter) qui est injecté.</li>
<li>Le modèle de domaine reste ignorant de tout cela.</li>
</ol>
<h2 id="exercices">Exercices<a class="headerlink" href="#exercices" title="Permanent link">&para;</a></h2>
<div class="admonition example">
<p class="admonition-title">Exercice 1 -- FileRepository</p>
<p>Implémentez un <code>FileRepository</code> qui persiste les produits dans un fichier JSON. Il doit respecter le contrat de <code>AbstractRepository</code> (méthodes <code>_add</code>, <code>_get</code>, <code>_get_par_réf_lot</code>). Écrivez un test pour vérifier qu'on peut ajouter un produit, puis le retrouver après avoir recréé le repository.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Exercice 2 -- Méthode <code>list_all</code></p>
<p>Ajoutez une méthode <code>list_all() -&gt; list[Produit]</code> à l'<code>AbstractRepository</code>. Implémentez-la dans <code>SqlAlchemyRepository</code> et <code>FakeRepository</code>. Réfléchissez : cette méthode devrait-elle ajouter les produits à <code>seen</code> ?</p>
</div>
<div class="admonition example">
<p class="admonition-title">Exercice 3 -- Vérifier le mapping ORM</p>
<p>Écrivez un test d'intégration qui crée un <code>Produit</code> avec un <code>Lot</code>, le persiste via <code>SqlAlchemyRepository</code>, puis le recharge et vérifie que tous les attributs sont corrects. Utilisez une base SQLite en mémoire (<code>sqlite://</code>).</p>
</div>
<hr />
<h2 id="resume">Résumé<a class="headerlink" href="#resume" title="Permanent link">&para;</a></h2>
<h3 id="tableau-des-concepts">Tableau des concepts<a class="headerlink" href="#tableau-des-concepts" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Rôle</th>
<th>Fichier</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Repository</strong></td>
<td>Abstraction de la couche de persistance</td>
<td><code>adapters/repository.py</code></td>
</tr>
<tr>
<td><strong>Port</strong> (<code>AbstractRepository</code>)</td>
<td>Interface définie par le domaine</td>
<td><code>adapters/repository.py</code></td>
</tr>
<tr>
<td><strong>Adapter</strong> (<code>SqlAlchemyRepository</code>)</td>
<td>Implémentation concrète du port</td>
<td><code>adapters/repository.py</code></td>
</tr>
<tr>
<td><strong>Classical Mapping</strong></td>
<td>Liaison entre classes du domaine et tables SQL</td>
<td><code>adapters/orm.py</code></td>
</tr>
<tr>
<td><strong>Persistence Ignorance</strong></td>
<td>Le domaine ne connaît pas la BDD</td>
<td><code>domain/model.py</code></td>
</tr>
<tr>
<td><strong>Fake</strong> (<code>FakeRepository</code>)</td>
<td>Implémentation en mémoire pour les tests</td>
<td><code>tests/unit/test_handlers.py</code></td>
</tr>
</tbody>
</table>
<h3 id="avantages">Avantages<a class="headerlink" href="#avantages" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Découplage</strong> -- Le modèle de domaine ne dépend pas de la technologie de persistance. On peut changer de BDD sans modifier la logique métier.</li>
<li><strong>Testabilité</strong> -- Grâce au fake, les tests unitaires sont rapides, isolés et déterministes. Pas besoin de base de données pour tester la logique métier.</li>
<li><strong>Lisibilité</strong> -- L'interface <code>add()</code> / <code>get()</code> est simple et intuitive. Le code métier lit comme du langage naturel.</li>
<li><strong>Extensibilité</strong> -- Ajouter une nouvelle source de données revient à écrire un nouvel adapter. Le reste du système n'est pas affecté.</li>
</ul>
<h3 id="inconvenients">Inconvénients<a class="headerlink" href="#inconvenients" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Complexité additionnelle</strong> -- On introduit une couche d'abstraction supplémentaire (interface + implémentation + mapping ORM). Pour une application très simple, c'est du sur-engineering.</li>
<li><strong>Courbe d'apprentissage</strong> -- Le classical mapping de SQLAlchemy est moins intuitif que l'approche déclarative. Il faut comprendre le concept de ports and adapters pour saisir la motivation.</li>
<li><strong>Code supplémentaire</strong> -- Le fake doit être maintenu en parallèle de l'implémentation réelle. Si l'interface évolue, il faut mettre à jour les deux.</li>
</ul>
<div class="admonition quote">
<p class="admonition-title">Règle d'or</p>
<p>Le pattern Repository n'est pas nécessaire pour toutes les applications. Il prend tout son sens quand la logique métier est suffisamment complexe pour mériter d'être isolée et testée indépendamment de la base de données.</p>
</div>
<hr />
<p><strong>Prochain chapitre</strong> : <a href="../chapitre_03_abstractions/">Chapitre 3 -- Couplage et abstractions</a>, où nous approfondirons le principe d'inversion des dépendances et les stratégies pour introduire des abstractions pertinentes.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "content.code.annotate", "navigation.sections", "navigation.expand", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>