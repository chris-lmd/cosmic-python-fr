
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Guide francophone des patterns d'architecture logicielle en Python">
      
      
      
      
        <link rel="prev" href="../chapitre_06_unit_of_work/">
      
      
        <link rel="next" href="../../partie2/chapitre_08_events/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>Chapitre 7 - Agrégats et frontières de cohérence - Patterns d'Architecture en Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapitre-7-agregats-et-frontieres-de-coherence" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href="../.." title="Patterns d&#39;Architecture en Python" class="md-header__button md-logo" aria-label="Patterns d'Architecture en Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Patterns d'Architecture en Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapitre 7 - Agrégats et frontières de cohérence
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Recherche">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Patterns d&#39;Architecture en Python" class="md-nav__button md-logo" aria-label="Patterns d'Architecture en Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Patterns d'Architecture en Python
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chapitre_00_mise_en_route/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 0 - Mise en route
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Partie 1 - Construire une architecture pour le Domain Modeling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Partie 1 - Construire une architecture pour le Domain Modeling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_01_modele_domaine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 1 - Le modèle de domaine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_02_repository/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 2 - Le pattern Repository
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_03_abstractions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 3 - Couplage et abstractions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_04_service_layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 4 - La Service Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_05_tdd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 5 - TDD à haute et basse vitesse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapitre_06_unit_of_work/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 6 - Le pattern Unit of Work
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 7 - Agrégats et frontières de cohérence
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 7 - Agrégats et frontières de cohérence
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#le-probleme-un-domaine-sans-frontieres" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le problème : un domaine sans frontières
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lagregat-un-cluster-dobjets-coherents" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'Agrégat : un cluster d'objets cohérents
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#laggregate-root-le-point-dentree-unique" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'Aggregate Root : le point d'entrée unique
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-classe-produit-notre-aggregate-root" class="md-nav__link">
    <span class="md-ellipsis">
      
        La classe Produit : notre Aggregate Root
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La classe Produit : notre Aggregate Root">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#la-methode-allouer" class="md-nav__link">
    <span class="md-ellipsis">
      
        La méthode allouer()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-methode-modifier_quantite_lot" class="md-nav__link">
    <span class="md-ellipsis">
      
        La méthode modifier_quantité_lot()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-repository-manipule-des-agregats" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le Repository manipule des Agrégats
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#choisir-les-frontieres-de-lagregat" class="md-nav__link">
    <span class="md-ellipsis">
      
        Choisir les frontières de l'Agrégat
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Choisir les frontières de l&#39;Agrégat">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trop-gros-le-probleme-de-la-contention" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trop gros : le problème de la contention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trop-petit-le-probleme-de-lincoherence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trop petit : le problème de l'incohérence
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-bonne-granularite-produit" class="md-nav__link">
    <span class="md-ellipsis">
      
        La bonne granularité : Produit
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-versioning-optimiste-optimistic-locking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le versioning optimiste (Optimistic Locking)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#les-domain-events-emis-par-lagregat" class="md-nav__link">
    <span class="md-ellipsis">
      
        Les Domain Events émis par l'Agrégat
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#schema-recapitulatif" class="md-nav__link">
    <span class="md-ellipsis">
      
        Schéma récapitulatif
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resume" class="md-nav__link">
    <span class="md-ellipsis">
      
        Résumé
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Exercices
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Partie 2 - Architecture événementielle
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Partie 2 - Architecture événementielle
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_08_events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 8 - Events et le Message Bus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_09_message_bus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 9 - Aller plus loin avec le Message Bus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_10_commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 10 - Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_11_events_externes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 11 - Events externes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_12_cqrs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 12 - CQRS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partie2/chapitre_13_injection_dependances/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chapitre 13 - Injection de dépendances
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../epilogue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Épilogue
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#le-probleme-un-domaine-sans-frontieres" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le problème : un domaine sans frontières
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lagregat-un-cluster-dobjets-coherents" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'Agrégat : un cluster d'objets cohérents
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#laggregate-root-le-point-dentree-unique" class="md-nav__link">
    <span class="md-ellipsis">
      
        L'Aggregate Root : le point d'entrée unique
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#la-classe-produit-notre-aggregate-root" class="md-nav__link">
    <span class="md-ellipsis">
      
        La classe Produit : notre Aggregate Root
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="La classe Produit : notre Aggregate Root">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#la-methode-allouer" class="md-nav__link">
    <span class="md-ellipsis">
      
        La méthode allouer()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-methode-modifier_quantite_lot" class="md-nav__link">
    <span class="md-ellipsis">
      
        La méthode modifier_quantité_lot()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-repository-manipule-des-agregats" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le Repository manipule des Agrégats
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#choisir-les-frontieres-de-lagregat" class="md-nav__link">
    <span class="md-ellipsis">
      
        Choisir les frontières de l'Agrégat
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Choisir les frontières de l&#39;Agrégat">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trop-gros-le-probleme-de-la-contention" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trop gros : le problème de la contention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trop-petit-le-probleme-de-lincoherence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Trop petit : le problème de l'incohérence
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-bonne-granularite-produit" class="md-nav__link">
    <span class="md-ellipsis">
      
        La bonne granularité : Produit
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#le-versioning-optimiste-optimistic-locking" class="md-nav__link">
    <span class="md-ellipsis">
      
        Le versioning optimiste (Optimistic Locking)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#les-domain-events-emis-par-lagregat" class="md-nav__link">
    <span class="md-ellipsis">
      
        Les Domain Events émis par l'Agrégat
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#schema-recapitulatif" class="md-nav__link">
    <span class="md-ellipsis">
      
        Schéma récapitulatif
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resume" class="md-nav__link">
    <span class="md-ellipsis">
      
        Résumé
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Exercices
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="chapitre-7-agregats-et-frontieres-de-coherence">Chapitre 7 -- Agrégats et frontières de cohérence<a class="headerlink" href="#chapitre-7-agregats-et-frontieres-de-coherence" title="Permanent link">&para;</a></h1>
<div class="admonition info">
<p class="admonition-title">Avant / Après</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Avant</strong></td>
<td>Fonction libre <code>allouer(ligne, lots)</code> sans garantie</td>
</tr>
<tr>
<td><strong>Après</strong></td>
<td><code>Produit</code> Aggregate Root + <code>numéro_version</code> (optimistic locking)</td>
</tr>
</tbody>
</table>
</div>
<div class="admonition info">
<p class="admonition-title">Ce que vous allez apprendre</p>
<ul>
<li>Pourquoi un modèle de domaine sans frontières claires mène à des incohérences</li>
<li>Ce qu'est un <strong>Agrégat</strong> et comment il protège les invariants métier</li>
<li>Le rôle de l'<strong>Aggregate Root</strong> comme point d'entrée unique</li>
<li>Comment choisir les frontières d'un agrégat</li>
<li>Comment le <strong>numéro_version</strong> et l'<strong>optimistic locking</strong> protègent contre les accès concurrents</li>
<li>Comment <code>Produit</code> devient l'agrégat qui contient les <code>Lot</code></li>
</ul>
</div>
<hr />
<h2 id="le-probleme-un-domaine-sans-frontieres">Le problème : un domaine sans frontières<a class="headerlink" href="#le-probleme-un-domaine-sans-frontieres" title="Permanent link">&para;</a></h2>
<p>Au chapitre 1, nous avons défini une fonction libre <code>allouer(ligne, lots)</code> qui prend une liste de lots et choisit le meilleur. C'est simple et lisible, mais cela pose un problème fondamental : <strong>qui est responsable de fournir la bonne liste de lots ?</strong> Rien n'empêche du code extérieur de manipuler directement un <code>Lot</code>, de modifier sa quantité, ou d'allouer une ligne sans passer par cette stratégie.</p>
<p>Imaginons deux requêtes HTTP simultanées qui tentent d'allouer la même quantité de stock :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Requete A                          Requete B
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    |                                  |
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    |  lire lot (dispo = 10)           |
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    |                                  |  lire lot (dispo = 10)
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    |  allouer 10 unites               |
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    |                                  |  allouer 10 unites
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    |  sauvegarder (dispo = 0)         |
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    |                                  |  sauvegarder (dispo = 0)
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    v                                  v
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    Resultat : 20 unites allouees pour 10 disponibles !
</code></pre></div>
<p>Sans frontière de cohérence, rien ne garantit que les invariants métier (on ne peut pas allouer plus que le stock disponible) sont respectés. Chaque requête voit un état valide au moment de la lecture, mais l'état global devient incohérent après l'écriture.</p>
<p>Ce problème est fondamental : <strong>dans un système concurrent, il faut définir explicitement quels objets doivent être modifiés ensemble, dans une même transaction</strong>.</p>
<hr />
<h2 id="lagregat-un-cluster-dobjets-coherents">L'Agrégat : un cluster d'objets cohérents<a class="headerlink" href="#lagregat-un-cluster-dobjets-coherents" title="Permanent link">&para;</a></h2>
<p>Un <strong>Agrégat</strong> est un regroupement d'objets du domaine qui forment une unité de cohérence. Toute modification à l'intérieur de l'agrégat doit respecter les invariants métier -- les règles qui doivent <strong>toujours</strong> être vraies.</p>
<p>Les principes fondamentaux :</p>
<ul>
<li><strong>Un agrégat = une transaction.</strong> On ne modifie qu'un seul agrégat par transaction.</li>
<li><strong>Les objets internes sont inaccessibles de l'extérieur.</strong> On ne peut pas aller chercher un <code>Lot</code> directement, on passe par l'agrégat.</li>
<li><strong>Un seul point d'entrée</strong> : l'Aggregate Root.</li>
</ul>
<p>Dans notre domaine, les invariants sont :</p>
<ol>
<li>On ne peut pas allouer une <code>LigneDeCommande</code> à un <code>Lot</code> si la quantité disponible est insuffisante.</li>
<li>L'allocation doit privilégier les lots en stock, puis ceux avec l'ETA la plus proche.</li>
<li>Si la quantité d'un lot change, les allocations en excédent doivent être désallouées.</li>
</ol>
<p>Toutes ces règles impliquent de raisonner sur <strong>l'ensemble des <code>Lot</code> pour un SKU donné</strong>. C'est donc le <code>Produit</code> (un SKU et ses lots) qui constitue notre agrégat.</p>
<hr />
<h2 id="laggregate-root-le-point-dentree-unique">L'Aggregate Root : le point d'entrée unique<a class="headerlink" href="#laggregate-root-le-point-dentree-unique" title="Permanent link">&para;</a></h2>
<p>L'<strong>Aggregate Root</strong> est l'objet par lequel on accède à tout le contenu de l'agrégat. C'est lui qui :</p>
<ul>
<li><strong>Expose les opérations métier</strong> (allouer, modifier une quantité)</li>
<li><strong>Vérifie les invariants</strong> avant chaque modification</li>
<li><strong>Contrôle l'accès</strong> aux objets internes (<code>Lot</code>, <code>LigneDeCommande</code>)</li>
</ul>
<p>Le code extérieur ne doit jamais manipuler directement un <code>Lot</code>. Il demande au <code>Produit</code> de le faire :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Correct : passer par l&#39;aggregate root</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">produit</span><span class="o">.</span><span class="n">allouer</span><span class="p">(</span><span class="n">ligne_de_commande</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1"># Incorrect : manipuler un Lot directement</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="n">lot</span> <span class="o">=</span> <span class="n">somehow_get_lot</span><span class="p">(</span><span class="s2">&quot;lot-001&quot;</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="n">lot</span><span class="o">.</span><span class="n">allouer</span><span class="p">(</span><span class="n">ligne_de_commande</span><span class="p">)</span>  <span class="c1"># Aucune garantie de coherence !</span>
</code></pre></div>
<p>Cette règle a une conséquence directe sur le <strong>Repository</strong> : il manipule des <code>Produit</code>, pas des <code>Lot</code>.</p>
<hr />
<h2 id="la-classe-produit-notre-aggregate-root">La classe <code>Produit</code> : notre Aggregate Root<a class="headerlink" href="#la-classe-produit-notre-aggregate-root" title="Permanent link">&para;</a></h2>
<p>La fonction libre <code>allouer(ligne, lots)</code> du chapitre 1 va maintenant <strong>devenir une méthode</strong> de <code>Produit</code>. L'agrégat possède les lots et prend la responsabilité de la stratégie d'allocation. La différence clé : au lieu de lever une exception <code>RuptureDeStock</code>, l'agrégat <strong>émet un événement</strong> (nous verrons pourquoi au chapitre 8).</p>
<p>Voici la classe <code>Produit</code> telle qu'elle apparaît dans notre code source
(<code>src/allocation/domain/model.py</code>) :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Produit</span><span class="p">:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="sd">    Agregat racine pour la gestion des produits.</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="sd">    Un Produit regroupe tous les Lot pour un SKU donne.</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="sd">    C&#39;est la frontiere de coherence : toutes les operations</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="sd">    d&#39;allocation passent par cet agregat.</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>        <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="n">lots</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Lot</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>        <span class="n">numéro_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="p">):</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lots</span> <span class="o">=</span> <span class="n">lots</span> <span class="ow">or</span> <span class="p">[]</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">numéro_version</span> <span class="o">=</span> <span class="n">numéro_version</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">événements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">events</span><span class="o">.</span><span class="n">Event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>
<p>Trois attributs méritent une attention particulière :</p>
<table>
<thead>
<tr>
<th>Attribut</th>
<th>Rôle</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sku</code></td>
<td>L'identité de l'agrégat. C'est le SKU du produit.</td>
</tr>
<tr>
<td><code>lots</code></td>
<td>Les objets internes à l'agrégat. La liste de tous les lots pour ce SKU.</td>
</tr>
<tr>
<td><code>numéro_version</code></td>
<td>Le compteur de version pour l'optimistic locking (voir plus bas).</td>
</tr>
</tbody>
</table>
<p>Et une liste <code>événements</code> qui collecte les domain events émis par les opérations métier.</p>
<h3 id="la-methode-allouer">La méthode <code>allouer()</code><a class="headerlink" href="#la-methode-allouer" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">allouer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ligne</span><span class="p">:</span> <span class="n">LigneDeCommande</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="sd">    Alloue une ligne de commande au lot le plus approprie.</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="sd">    La strategie d&#39;allocation privilegie les lots en stock</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="sd">    (sans ETA) puis les lots avec l&#39;ETA la plus proche.</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="sd">    Retourne la reference du lot choisi.</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="sd">    Emet un evenement RuptureDeStock s&#39;il n&#39;y a plus de stock.</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="n">lot</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>            <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lots</span><span class="p">)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>            <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">peut_allouer</span><span class="p">(</span><span class="n">ligne</span><span class="p">)</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        <span class="p">)</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">événements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">RuptureDeStock</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">ligne</span><span class="o">.</span><span class="n">sku</span><span class="p">))</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="n">lot</span><span class="o">.</span><span class="n">allouer</span><span class="p">(</span><span class="n">ligne</span><span class="p">)</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">numéro_version</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>    <span class="k">return</span> <span class="n">lot</span><span class="o">.</span><span class="n">référence</span>
</code></pre></div>
<p>Observons les responsabilités de cette méthode :</p>
<ol>
<li><strong>Elle trie les lots</strong> (<code>sorted(self.lots)</code>) pour appliquer la stratégie d'allocation (stock d'abord, puis ETA la plus proche).</li>
<li><strong>Elle trouve le premier lot capable</strong> d'accueillir la ligne (<code>l.peut_allouer(ligne)</code>).</li>
<li><strong>Elle gère le cas d'erreur</strong> : si aucun lot ne convient, elle émet un événement <code>RuptureDeStock</code> au lieu de lever une exception.</li>
<li><strong>Elle incrémente le <code>numéro_version</code></strong> après chaque allocation réussie.</li>
<li><strong>Elle retourne la référence du lot choisi</strong>, permettant au code appelant de savoir où l'allocation a été faite.</li>
</ol>
<p>Le code appelant (la service layer) n'a aucune connaissance des <code>Lot</code> individuels. Il demande simplement au <code>Produit</code> d'allouer.</p>
<h3 id="la-methode-modifier_quantite_lot">La méthode <code>modifier_quantité_lot()</code><a class="headerlink" href="#la-methode-modifier_quantite_lot" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">modifier_quantité_lot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">réf</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quantité</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="sd">    Modifie la quantite d&#39;un lot et realloue si necessaire.</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="sd">    Si la nouvelle quantite est inferieure aux allocations existantes,</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="sd">    les lignes en excedent sont desallouees et des evenements</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="sd">    Désalloué sont emis pour chacune.</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="n">lot</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lots</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">référence</span> <span class="o">==</span> <span class="n">réf</span><span class="p">)</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="n">lot</span><span class="o">.</span><span class="n">_quantité_achetée</span> <span class="o">=</span> <span class="n">quantité</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="k">while</span> <span class="n">lot</span><span class="o">.</span><span class="n">quantité_disponible</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="n">ligne</span> <span class="o">=</span> <span class="n">lot</span><span class="o">.</span><span class="n">désallouer_une</span><span class="p">()</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">événements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>            <span class="n">events</span><span class="o">.</span><span class="n">Désalloué</span><span class="p">(</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>                <span class="n">id_commande</span><span class="o">=</span><span class="n">ligne</span><span class="o">.</span><span class="n">id_commande</span><span class="p">,</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>                <span class="n">sku</span><span class="o">=</span><span class="n">ligne</span><span class="o">.</span><span class="n">sku</span><span class="p">,</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>                <span class="n">quantité</span><span class="o">=</span><span class="n">ligne</span><span class="o">.</span><span class="n">quantité</span><span class="p">,</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>            <span class="p">)</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="p">)</span>
</code></pre></div>
<p>Cette méthode illustre un scénario plus complexe :</p>
<ol>
<li>Elle retrouve le lot concerné <strong>à l'intérieur de l'agrégat</strong> (pas via le repository).</li>
<li>Elle modifie la quantité achetée.</li>
<li>Si la quantité disponible devient négative, elle <strong>désalloue progressivement</strong> des lignes de commande.</li>
<li>Pour chaque ligne désallouée, elle émet un événement <code>Désalloué</code>. Ce sont ces events qui déclencheront une réallocation ailleurs dans le système (via le message bus, que nous verrons au chapitre 8).</li>
</ol>
<hr />
<h2 id="le-repository-manipule-des-agregats">Le Repository manipule des Agrégats<a class="headerlink" href="#le-repository-manipule-des-agregats" title="Permanent link">&para;</a></h2>
<p>Le repository est l'interface entre le domaine et la persistance. Il doit opérer au niveau de l'agrégat, pas au niveau de ses composants internes.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AbstractRepository</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">produit</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ajoute un produit au repository.&quot;&quot;&quot;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>        <span class="o">...</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Recupere un produit par son SKU.&quot;&quot;&quot;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        <span class="o">...</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_par_réf_lot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">réf_lot</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Produit</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Recupere un produit contenant le lot de reference donnee.&quot;&quot;&quot;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        <span class="o">...</span>
</code></pre></div>
<p>On remarque :</p>
<ul>
<li><strong><code>add()</code> et <code>get()</code> travaillent avec des <code>Produit</code></strong>, jamais des <code>Lot</code>.</li>
<li><strong><code>get_par_réf_lot()</code></strong> retrouve le <code>Produit</code> parent à partir d'une référence de lot. Même ici, c'est l'agrégat entier qui est retourné.</li>
<li>La méthode <code>seen</code> (un <code>set[Produit]</code>) permet de garder une trace de tous les agrégats chargés ou ajoutés, ce qui sera utile pour collecter les domain events.</li>
</ul>
<hr />
<h2 id="choisir-les-frontieres-de-lagregat">Choisir les frontières de l'Agrégat<a class="headerlink" href="#choisir-les-frontieres-de-lagregat" title="Permanent link">&para;</a></h2>
<p>Le choix des frontières est une décision de conception cruciale. La règle à retenir :</p>
<div class="admonition warning">
<p class="admonition-title">Un agrégat = une transaction = un verrou</p>
<p>Chaque agrégat délimite une <strong>transaction</strong>. Pendant qu'une transaction modifie un agrégat, aucune autre transaction ne peut le modifier. C'est ainsi qu'on garantit la cohérence.</p>
</div>
<h3 id="trop-gros-le-probleme-de-la-contention">Trop gros : le problème de la contention<a class="headerlink" href="#trop-gros-le-probleme-de-la-contention" title="Permanent link">&para;</a></h3>
<p>Si on faisait un agrégat unique <code>Entrepôt</code> contenant <strong>tous</strong> les produits et <strong>tous</strong> les lots, chaque allocation verrouillerait l'ensemble du stock. Deux commandes pour des produits différents ne pourraient pas être traitées en parallèle.</p>
<h3 id="trop-petit-le-probleme-de-lincoherence">Trop petit : le problème de l'incohérence<a class="headerlink" href="#trop-petit-le-probleme-de-lincoherence" title="Permanent link">&para;</a></h3>
<p>Si chaque <code>Lot</code> était son propre agrégat, on n'aurait aucun moyen de garantir que l'allocation choisit le bon lot. Deux transactions pourraient allouer le même lot simultanément sans le savoir.</p>
<h3 id="la-bonne-granularite-produit">La bonne granularité : <code>Produit</code><a class="headerlink" href="#la-bonne-granularite-produit" title="Permanent link">&para;</a></h3>
<p>Un <code>Produit</code> regroupe tous les lots pour un SKU donné. C'est le bon compromis :</p>
<ul>
<li><strong>Cohérence</strong> : toutes les règles d'allocation pour un SKU sont vérifiées dans une seule transaction.</li>
<li><strong>Concurrence</strong> : deux allocations pour des SKU différents se font en parallèle sans conflit.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>+-------------------+   +-------------------+
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>|  Produit (SKU-A)  |   |  Produit (SKU-B)  |
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>|  +-------+        |   |  +-------+        |
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>|  | Lot 1 |        |   |  | Lot 3 |        |
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>|  +-------+        |   |  +-------+        |
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>|  +-------+        |   |  +-------+        |
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>|  | Lot 2 |        |   |  | Lot 4 |        |
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>|  +-------+        |   |  +-------+        |
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>+-------------------+   +-------------------+
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>  ^ transaction A        ^ transaction B
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>  (independantes)
</code></pre></div>
<hr />
<h2 id="le-versioning-optimiste-optimistic-locking">Le versioning optimiste (Optimistic Locking)<a class="headerlink" href="#le-versioning-optimiste-optimistic-locking" title="Permanent link">&para;</a></h2>
<p>Même avec des frontières d'agrégat bien choisies, il reste un risque : deux transactions concurrentes peuvent tenter de modifier <strong>le même</strong> <code>Produit</code> simultanément. Le <strong>numéro_version</strong> résout ce problème :</p>
<ol>
<li>Quand on charge un <code>Produit</code>, on lit son <code>numéro_version</code>.</li>
<li>Quand on le sauvegarde, on vérifie que le <code>numéro_version</code> en base n'a pas changé.</li>
<li>Si le numéro a changé (une autre transaction est passée entre-temps), la sauvegarde échoue.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Transaction A                       Transaction B
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>     |                                   |
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>     | SELECT ... =&gt; version = 3         |
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>     |                                   | SELECT ... =&gt; version = 3
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>     | allouer(...) =&gt; version = 4       |
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>     |                                   | allouer(...) =&gt; version = 4
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>     | UPDATE ... WHERE version=3        |
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>     | =&gt; OK (1 row)                     |
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>     |                                   | UPDATE ... WHERE version=3
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>     |                                   | =&gt; ECHEC (0 rows)
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>     v                                   v
</code></pre></div>
<p>La transaction B échoue car la clause <code>WHERE numéro_version=3</code> ne correspond plus à l'état en base. C'est le principe de l'<strong>optimistic locking</strong> : on suppose que les conflits sont rares, mais on les détecte au moment du <code>commit</code>.</p>
<p>Dans le mapping ORM (<code>src/allocation/adapters/orm.py</code>), la table <code>products</code> porte ce champ :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">products</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="s2">&quot;products&quot;</span><span class="p">,</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;sku&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;numero_version&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">),</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="p">)</span>
</code></pre></div>
<p>Et dans la classe <code>Produit</code>, chaque appel à <code>allouer()</code> incrémente le compteur :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">lot</span><span class="o">.</span><span class="n">allouer</span><span class="p">(</span><span class="n">ligne</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="bp">self</span><span class="o">.</span><span class="n">numéro_version</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">return</span> <span class="n">lot</span><span class="o">.</span><span class="n">référence</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Pourquoi optimiste ?</p>
<p>On parle de verrouillage <strong>optimiste</strong> parce qu'on ne pose pas de verrou explicite en base de données (pas de <code>SELECT ... FOR UPDATE</code>). On laisse les transactions avancer en parallèle et on ne détecte le conflit qu'au moment du <code>commit</code>. C'est plus performant quand les conflits sont rares.</p>
</div>
<hr />
<h2 id="les-domain-events-emis-par-lagregat">Les Domain Events émis par l'Agrégat<a class="headerlink" href="#les-domain-events-emis-par-lagregat" title="Permanent link">&para;</a></h2>
<p>L'agrégat <code>Produit</code> ne se contente pas de modifier son état interne. Il <strong>émet des événements</strong> qui signalent ce qui s'est passé :</p>
<table>
<thead>
<tr>
<th>Événement</th>
<th>Quand</th>
<th>Déclencheur</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RuptureDeStock</code></td>
<td>Aucun lot ne peut accueillir la ligne</td>
<td><code>allouer()</code></td>
</tr>
<tr>
<td><code>Désalloué</code></td>
<td>Une ligne est désallouée suite à un changement de quantité</td>
<td><code>modifier_quantité_lot()</code></td>
</tr>
</tbody>
</table>
<p>Ces événements sont collectés dans <code>self.événements</code> et seront publiés par l'infrastructure (le Unit of Work et le message bus) après la transaction. C'est une séparation nette entre "ce qui s'est passé" et "ce qu'il faut faire ensuite".</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Dans Produit.__init__</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="bp">self</span><span class="o">.</span><span class="n">événements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">events</span><span class="o">.</span><span class="n">Event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="c1"># Dans allouer(), si rupture de stock :</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="bp">self</span><span class="o">.</span><span class="n">événements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">RuptureDeStock</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">ligne</span><span class="o">.</span><span class="n">sku</span><span class="p">))</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="c1"># Dans modifier_quantité_lot(), pour chaque ligne désallouée :</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="bp">self</span><span class="o">.</span><span class="n">événements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="n">events</span><span class="o">.</span><span class="n">Désalloué</span><span class="p">(</span><span class="n">id_commande</span><span class="o">=</span><span class="n">ligne</span><span class="o">.</span><span class="n">id_commande</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="n">ligne</span><span class="o">.</span><span class="n">sku</span><span class="p">,</span> <span class="n">quantité</span><span class="o">=</span><span class="n">ligne</span><span class="o">.</span><span class="n">quantité</span><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="schema-recapitulatif">Schéma récapitulatif<a class="headerlink" href="#schema-recapitulatif" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>+------------------------------------------------------------+
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>|                                                            |
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>|   Aggregate : Produit                                      |
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>|                                                            |
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>|   Identite :  sku = &quot;BLUE-VASE&quot;                            |
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>|   Version :   numéro_version = 3                           |
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>|   Events :    [RuptureDeStock(...), Désalloué(...)]        |
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>|                                                            |
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>|   +------------------------+  +------------------------+   |
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>|   |  Lot                   |  |  Lot                   |   |
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>|   |  référence: &quot;lot-01&quot;   |  |  référence: &quot;lot-02&quot;   |   |
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>|   |  sku: &quot;BLUE-VASE&quot;      |  |  sku: &quot;BLUE-VASE&quot;      |   |
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>|   |  quantité: 100         |  |  quantité: 50          |   |
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>|   |  eta: None (en stock)  |  |  eta: 2025-03-15       |   |
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>|   |                        |  |                        |   |
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>|   |  _allocations:         |  |  _allocations:         |   |
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>|   |    {LigneDeCommande(.),|  |    {LigneDeCommande(.)}|   |
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>|   |     LigneDeCommande(.)}|  |                        |   |
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>|   +------------------------+  +------------------------+   |
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>|                                                            |
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>+------------------------------------------------------------+
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>         ^
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>         |
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    Aggregate Root : le seul point d&#39;acces
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>    Repository.get(&quot;BLUE-VASE&quot;) -&gt; Produit
</code></pre></div>
<hr />
<h2 id="resume">Résumé<a class="headerlink" href="#resume" title="Permanent link">&para;</a></h2>
<p>Les <strong>Agrégats</strong> sont la réponse du Domain-Driven Design au problème de la cohérence dans un système concurrent. En délimitant des frontières claires, ils permettent de raisonner localement sur les invariants tout en préservant la performance globale du système.</p>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Ce qu'il faut retenir</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Agrégat</strong></td>
<td>Un cluster d'objets modifiés ensemble dans une seule transaction.</td>
</tr>
<tr>
<td><strong>Aggregate Root</strong></td>
<td>Le point d'entrée unique de l'agrégat. Toutes les opérations passent par lui.</td>
</tr>
<tr>
<td><strong>Invariant</strong></td>
<td>Une règle métier qui doit toujours être vraie. L'agrégat la garantit.</td>
</tr>
<tr>
<td><strong>Frontière</strong></td>
<td>Un agrégat = une transaction = un verrou. Ni trop gros, ni trop petit.</td>
</tr>
<tr>
<td><strong>Optimistic Locking</strong></td>
<td>Le <code>numéro_version</code> détecte les conflits entre transactions concurrentes.</td>
</tr>
<tr>
<td><strong>Repository</strong></td>
<td>Il travaille au niveau de l'agrégat, pas de ses composants internes.</td>
</tr>
<tr>
<td><strong>Domain Events</strong></td>
<td>L'agrégat émet des événements pour signaler ce qui s'est passé.</td>
</tr>
</tbody>
</table>
<h2 id="exercices">Exercices<a class="headerlink" href="#exercices" title="Permanent link">&para;</a></h2>
<div class="admonition example">
<p class="admonition-title">Exercice 1 -- Frontières alternatives</p>
<p>Imaginez que chaque <code>Lot</code> soit son propre agrégat (pas de <code>Produit</code> englobant). Quels invariants ne pourraient plus être garantis ? Que se passerait-il en cas d'accès concurrent ?</p>
</div>
<div class="admonition example">
<p class="admonition-title">Exercice 2 -- Verrouillage pessimiste</p>
<p>Remplacez l'optimistic locking par un <code>SELECT ... FOR UPDATE</code> dans le repository SQLAlchemy. Quels sont les avantages et inconvénients de chaque approche ?</p>
</div>
<div class="admonition example">
<p class="admonition-title">Exercice 3 -- Nouvel invariant</p>
<p>Ajoutez la règle métier : "un produit ne peut pas avoir plus de 10 lots actifs". Où cette règle doit-elle vivre ? Implémentez-la dans <code>Produit</code> et écrivez le test correspondant.</p>
</div>
<hr />
<div class="admonition quote">
<p class="admonition-title">À retenir</p>
<p>L'agrégat est la réponse à la question : <strong>"quels objets doivent être cohérents entre eux ?"</strong>. Dans notre domaine, tous les lots d'un même produit doivent être cohérents, donc <code>Produit</code> est l'agrégat qui contient les <code>Lot</code>. Le <code>numéro_version</code> garantit qu'une seule transaction à la fois peut modifier un <code>Produit</code> donné.</p>
</div>
<hr />
<p><em>Chapitre suivant : <a href="../../partie2/chapitre_08_events/">Events et le Message Bus</a> -- comment les événements émis par l'agrégat déclenchent des actions dans le reste du système.</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "content.code.annotate", "navigation.sections", "navigation.expand", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>